name: "Release"

on:
  workflow_dispatch:
    inputs:
      version:
        type: choice
        description: What kind of release is this?
        required: true
        options:
          - patch
          - minor
          - major

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: production
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up SSH Agent
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.EC2_PRIVATE_KEY }}

      - name: Prepare EC2 Environment
        run: |
          ssh -o StrictHostKeyChecking=no ${{ vars.EC2_USER }}@${{ vars.EC2_HOST }} << EOF
            set -e
            
            # Update system packages
            sudo apt-get update -y
            
            # Install Node.js 20.x if not already installed
            if ! command -v node &> /dev/null; then
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi
            
            # Install nginx if not already installed
            if ! command -v nginx &> /dev/null; then
              sudo apt-get install -y nginx
            fi
            
            # Install PM2 globally if not already installed
            if ! command -v pm2 &> /dev/null; then
              sudo npm install -g pm2
            fi
            
            # Install Prisma CLI globally for generating Prisma Client
            if ! command -v prisma &> /dev/null; then
              sudo npm install -g prisma
            fi
            
            # Prepare application directories
            sudo mkdir -p /home/${{ vars.EC2_USER }}/app/api
            sudo mkdir -p /home/${{ vars.EC2_USER }}/app/dashboard
            sudo chown -R ${{ vars.EC2_USER }}:${{ vars.EC2_USER }} /home/${{ vars.EC2_USER }}/app
          EOF

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Build API
        run: |
          cd api
          npm ci --prefer-offline --no-audit
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" > .env
          echo "PORT=3001" >> .env
          npx prisma generate
          npm run build

          # Copy built artifacts to deployment directory
          mkdir -p ../deploy/api
          cp -r dist ../deploy/api/
          cp package.json ../deploy/api/
          cp package-lock.json ../deploy/api/ 2>/dev/null || true
          cp .env ../deploy/api/
          mkdir -p ../deploy/api/src/infra/prisma
          cp src/infra/prisma/schema.prisma ../deploy/api/src/infra/prisma/

          # Clean up to free memory
          rm -rf node_modules
          npm cache clean --force

      - name: Build Dashboard
        run: |
          cd dashboard
          npm ci --prefer-offline --no-audit
          NEXT_PUBLIC_API_URL=http://${{ vars.EC2_HOST }}/api NEXT_PUBLIC_WS_URL=ws://${{ vars.EC2_HOST }} npm run build

          # Copy built artifacts to deployment directory
          mkdir -p ../deploy/dashboard
          cp -r .next ../deploy/dashboard/
          cp package.json ../deploy/dashboard/
          cp package-lock.json ../deploy/dashboard/ 2>/dev/null || true
          cp -r public ../deploy/dashboard/ 2>/dev/null || true

          # Clean up to free memory
          rm -rf node_modules
          npm cache clean --force

      - name: Prepare Deployment Package
        run: |
          # Install production dependencies for API
          cd deploy/api
          npm ci --production --prefer-offline --no-audit

          # Install production dependencies for Dashboard
          cd ../dashboard
          npm ci --production --prefer-offline --no-audit

          # Final cleanup
          npm cache clean --force

      - name: Upload Built Applications
        run: |
          tar -czf deploy.tar.gz deploy
          scp -o StrictHostKeyChecking=no deploy.tar.gz ${{ vars.EC2_USER }}@${{ vars.EC2_HOST }}:/home/${{ vars.EC2_USER }}/app/
          ssh -o StrictHostKeyChecking=no ${{ vars.EC2_USER }}@${{ vars.EC2_HOST }} << EOF
            set -e
            cd /home/${{ vars.EC2_USER }}/app
            rm -rf api dashboard
            tar -xzf deploy.tar.gz
            mv deploy/api api
            mv deploy/dashboard dashboard
            rm -rf deploy deploy.tar.gz
          EOF

      - name: Configure PM2 and Start Applications
        run: |
          ssh -o StrictHostKeyChecking=no ${{ vars.EC2_USER }}@${{ vars.EC2_HOST }} << EOF
            set -e
            
            # Regenerate Prisma Client for platform compatibility
            cd /home/${{ vars.EC2_USER }}/app/api
            npm install --save-dev prisma@^6.6.0
            npx prisma generate --schema=src/infra/prisma/schema.prisma
            
            # Stop existing PM2 processes
            pm2 delete all || true
            
            # Start API with PM2 (using the serve script from package.json)
            cd /home/${{ vars.EC2_USER }}/app/api
            pm2 start npm --name "api" -- run serve
            
            # Start Dashboard with PM2 (using the start script from package.json)
            cd /home/${{ vars.EC2_USER }}/app/dashboard
            pm2 start npm --name "dashboard" -- start
            
            # Save PM2 configuration
            pm2 save
            
            # Set up PM2 startup script (only if not already configured)
            if ! pm2 startup | grep -q "already"; then
              sudo env PATH=\$PATH:/usr/bin pm2 startup systemd -u ${{ vars.EC2_USER }} --hp /home/${{ vars.EC2_USER }}
            fi
          EOF

      - name: Configure Nginx
        run: |
          cat > /tmp/nginx-wattsup.conf << 'EOF'
          server {
              listen 80;
              server_name _;
              
              # Dashboard (Next.js)
              location / {
                  proxy_pass http://localhost:3000;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_cache_bypass $http_upgrade;
              }
              
              # API endpoints - preserve /api prefix
              location /api {
                  proxy_pass http://localhost:3001/api;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_cache_bypass $http_upgrade;
              }
              
              # WebSocket support for telemetry
              location /telemetry {
                  proxy_pass http://localhost:3001;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection "upgrade";
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_read_timeout 86400;
              }
          }
          EOF

          scp -o StrictHostKeyChecking=no /tmp/nginx-wattsup.conf ${{ vars.EC2_USER }}@${{ vars.EC2_HOST }}:/tmp/nginx-wattsup.conf

          ssh -o StrictHostKeyChecking=no ${{ vars.EC2_USER }}@${{ vars.EC2_HOST }} << 'EOF'
            set -e
            
            # Move config to nginx directory
            sudo mv /tmp/nginx-wattsup.conf /etc/nginx/sites-available/wattsup
            
            # Remove default nginx site if it exists
            sudo rm -f /etc/nginx/sites-enabled/default
            
            # Enable the site (create symlink)
            sudo ln -sf /etc/nginx/sites-available/wattsup /etc/nginx/sites-enabled/wattsup
            
            # Verify symlink was created
            ls -la /etc/nginx/sites-enabled/
            
            # Test nginx configuration
            sudo nginx -t
            
            # Reload nginx
            sudo systemctl reload nginx
          EOF

      - name: Deployment Complete
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ðŸŒ Application URL: http://${{ vars.EC2_HOST }}"
          echo "ðŸ“Š Dashboard: http://${{ vars.EC2_HOST }}/"
          echo "ðŸ”Œ API: http://${{ vars.EC2_HOST }}/api"
