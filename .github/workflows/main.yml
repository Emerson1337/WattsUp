name: "Release"

on:
  workflow_dispatch:
    inputs:
      version:
        type: choice
        description: What kind of release is this?
        required: true
        options:
          - patch
          - minor
          - major

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: production
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up SSH Agent
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.EC2_PRIVATE_KEY }}

      - name: Prepare EC2 Environment
        run: |
          ssh -o StrictHostKeyChecking=no ${{ vars.EC2_USER }}@${{ vars.EC2_HOST }} << EOF
            set -e
            
            # Update system packages
            sudo apt-get update -y
            
            # Install Node.js 20.x if not already installed
            if ! command -v node &> /dev/null; then
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi
            
            # Install nginx if not already installed
            if ! command -v nginx &> /dev/null; then
              sudo apt-get install -y nginx
            fi
            
            # Install PM2 globally if not already installed
            if ! command -v pm2 &> /dev/null; then
              sudo npm install -g pm2
            fi
            
            # Install Prisma CLI globally for generating Prisma Client
            if ! command -v prisma &> /dev/null; then
              sudo npm install -g prisma
            fi
            
            # Prepare application directories
            sudo mkdir -p /home/${{ vars.EC2_USER }}/app/api
            sudo mkdir -p /home/${{ vars.EC2_USER }}/app/dashboard
            sudo chown -R ${{ vars.EC2_USER }}:${{ vars.EC2_USER }} /home/${{ vars.EC2_USER }}/app
          EOF

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Build API
        run: |
          cd api
          npm ci
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" > .env
          echo "PORT=3001" >> .env
          npx prisma generate
          npm run build

      - name: Build Dashboard
        run: |
          cd dashboard
          npm ci
          NEXT_PUBLIC_API_URL=http://${{ vars.EC2_HOST }}/api NEXT_PUBLIC_WS_URL=ws://${{ vars.EC2_HOST }} npm run build

      - name: Prepare Deployment Package
        run: |
          # Create deployment directories
          mkdir -p deploy/api deploy/dashboard

          # Copy API files (built dist, package.json, node_modules for production, .env, prisma schema)
          cp -r api/dist deploy/api/
          cp api/package.json deploy/api/
          cp api/package-lock.json deploy/api/ 2>/dev/null || true
          cp api/.env deploy/api/
          mkdir -p deploy/api/src/infra/prisma
          cp api/src/infra/prisma/schema.prisma deploy/api/src/infra/prisma/

          # Copy Dashboard files (built .next, package.json, node_modules for production, public)
          cp -r dashboard/.next deploy/dashboard/
          cp dashboard/package.json deploy/dashboard/
          cp dashboard/package-lock.json deploy/dashboard/ 2>/dev/null || true
          cp -r dashboard/public deploy/dashboard/ 2>/dev/null || true

          # Create production node_modules for API
          cd api
          npm ci --production
          cp -r node_modules ../deploy/api/

          # Create production node_modules for Dashboard
          cd ../dashboard
          npm ci --production
          cp -r node_modules ../deploy/dashboard/

      - name: Upload Built Applications
        run: |
          tar -czf deploy.tar.gz deploy
          scp -o StrictHostKeyChecking=no deploy.tar.gz ${{ vars.EC2_USER }}@${{ vars.EC2_HOST }}:/home/${{ vars.EC2_USER }}/app/
          ssh -o StrictHostKeyChecking=no ${{ vars.EC2_USER }}@${{ vars.EC2_HOST }} << EOF
            set -e
            cd /home/${{ vars.EC2_USER }}/app
            rm -rf api dashboard
            tar -xzf deploy.tar.gz
            mv deploy/api api
            mv deploy/dashboard dashboard
            rm -rf deploy deploy.tar.gz
          EOF

      - name: Configure PM2 and Start Applications
        run: |
          ssh -o StrictHostKeyChecking=no ${{ vars.EC2_USER }}@${{ vars.EC2_HOST }} << EOF
            set -e
            
            # Regenerate Prisma Client for platform compatibility
            cd /home/${{ vars.EC2_USER }}/app/api
            npm install --save-dev prisma@^6.6.0
            npx prisma generate --schema=src/infra/prisma/schema.prisma
            
            # Stop existing PM2 processes
            pm2 delete all || true
            
            # Start API with PM2 (using the serve script from package.json)
            cd /home/${{ vars.EC2_USER }}/app/api
            pm2 start npm --name "api" -- run serve
            
            # Start Dashboard with PM2 (using the start script from package.json)
            cd /home/${{ vars.EC2_USER }}/app/dashboard
            pm2 start npm --name "dashboard" -- start
            
            # Save PM2 configuration
            pm2 save
            
            # Set up PM2 startup script (only if not already configured)
            if ! pm2 startup | grep -q "already"; then
              sudo env PATH=\$PATH:/usr/bin pm2 startup systemd -u ${{ vars.EC2_USER }} --hp /home/${{ vars.EC2_USER }}
            fi
          EOF

      - name: Configure Nginx
        run: |
          ssh -o StrictHostKeyChecking=no ${{ vars.EC2_USER }}@${{ vars.EC2_HOST }} << 'NGINX_EOF'
            set -e
            
            # Create nginx configuration
            sudo tee /etc/nginx/sites-available/wattsup > /dev/null << 'EOF'
            server {
                listen 80;
                server_name _;
                
                # Dashboard (Next.js)
                location / {
                    proxy_pass http://localhost:3000;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    proxy_cache_bypass $http_upgrade;
                }
                
                # API endpoints
                location /api {
                    proxy_pass http://localhost:3001;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    proxy_cache_bypass $http_upgrade;
                }
                
                # WebSocket support for telemetry
                location /telemetry {
                    proxy_pass http://localhost:3001;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection "upgrade";
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    proxy_read_timeout 86400;
                }
            }
            EOF
            
            # Remove default nginx site if it exists
            sudo rm -f /etc/nginx/sites-enabled/default
            
            # Enable the site (create symlink)
            sudo ln -sf /etc/nginx/sites-available/wattsup /etc/nginx/sites-enabled/wattsup
            
            # Verify symlink was created
            ls -la /etc/nginx/sites-enabled/
            
            # Test nginx configuration
            sudo nginx -t
            
            # Reload nginx
            sudo systemctl reload nginx
          NGINX_EOF

      - name: Deployment Complete
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ðŸŒ Application URL: http://${{ vars.EC2_HOST }}"
          echo "ðŸ“Š Dashboard: http://${{ vars.EC2_HOST }}/"
          echo "ðŸ”Œ API: http://${{ vars.EC2_HOST }}/api"
